<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 데이터 수집 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .data-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
        }
        
        .stock-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }
        
        .stock-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .stock-item.down {
            border-left-color: #dc3545;
        }
        
        .price-up {
            color: #28a745;
            font-weight: bold;
        }
        
        .price-down {
            color: #dc3545;
            font-weight: bold;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .btn-danger-custom {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }
        
        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-custom {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table-custom {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .table-custom th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
        }
        
        .table-custom td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table-custom tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- 헤더 -->
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> 실시간 데이터 수집 대시보드</h1>
                    <p class="mb-0">키움 API 기반 실시간 주식 데이터 수집 및 분석 시스템</p>
                </div>
                <div class="col-md-4 text-end">
                    <div id="server-status" class="badge bg-success fs-6">
                        <i class="fas fa-circle"></i> 서버 연결됨
                    </div>
                </div>
            </div>
        </div>

        <!-- 제어 패널 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="status-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5><i class="fas fa-cogs"></i> 시스템 제어</h5>
                            <p class="mb-0">데이터 수집 시작/중지 및 종목 관리</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="start-btn" class="btn btn-custom me-2">
                                <i class="fas fa-play"></i> 수집 시작
                            </button>
                            <button id="stop-btn" class="btn btn-danger-custom me-2">
                                <i class="fas fa-stop"></i> 수집 중지
                            </button>
                            <button id="refresh-btn" class="btn btn-outline-secondary">
                                <i class="fas fa-sync-alt"></i> 새로고침
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-stocks">0</div>
                <div class="stat-label">구독 종목 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="data-received">0</div>
                <div class="stat-label">수신 데이터</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="data-processed">0</div>
                <div class="stat-label">처리 데이터</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="error-count">0</div>
                <div class="stat-label">오류 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uptime">00:00:00</div>
                <div class="stat-label">가동 시간</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="last-update">-</div>
                <div class="stat-label">마지막 업데이트</div>
            </div>
        </div>

        <!-- 시장 분석 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="data-card">
                    <h5><i class="fas fa-chart-pie"></i> 시장 추세 분석</h5>
                    <div class="chart-container">
                        <canvas id="marketTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="data-card">
                    <h5><i class="fas fa-fire"></i> 급등/급락 종목</h5>
                    <div id="hot-stocks-list" class="mt-3">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>데이터 로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 실시간 데이터 테이블 -->
        <div class="row">
            <div class="col-md-12">
                <div class="data-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-table"></i> 실시간 종목 데이터</h5>
                        <div>
                            <button id="export-btn" class="btn btn-custom btn-sm">
                                <i class="fas fa-download"></i> 데이터 내보내기
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>종목코드</th>
                                    <th>종목명</th>
                                    <th>현재가</th>
                                    <th>등락률</th>
                                    <th>거래량</th>
                                    <th>거래대금</th>
                                    <th>고가</th>
                                    <th>저가</th>
                                    <th>업데이트</th>
                                </tr>
                            </thead>
                            <tbody id="stock-data-table">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="loading">
                                            <div class="spinner"></div>
                                            <p>실시간 데이터 로딩 중...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 알림 영역 -->
        <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
    </div>

    <!-- 종목 구독 모달 -->
    <div class="modal fade" id="subscribeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">종목 구독 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="stock-codes" class="form-label">종목 코드 (쉼표로 구분)</label>
                        <input type="text" class="form-control" id="stock-codes" 
                               placeholder="예: 005930,000660,035420">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-custom" id="subscribe-confirm">구독</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class RealTimeDashboard {
            constructor() {
                this.apiBase = '/api';
                this.updateInterval = 5000; // 5초마다 업데이트
                this.charts = {};
                this.isRunning = false;
                
                this.initializeEventListeners();
                this.initializeCharts();
                this.startAutoUpdate();
            }
            
            initializeEventListeners() {
                // 제어 버튼
                document.getElementById('start-btn').addEventListener('click', () => this.startCollection());
                document.getElementById('stop-btn').addEventListener('click', () => this.stopCollection());
                document.getElementById('refresh-btn').addEventListener('click', () => this.refreshData());
                document.getElementById('export-btn').addEventListener('click', () => this.exportData());
                
                // 종목 구독
                document.getElementById('subscribe-confirm').addEventListener('click', () => this.subscribeStocks());
            }
            
            initializeCharts() {
                // 시장 추세 차트
                const marketTrendCtx = document.getElementById('marketTrendChart').getContext('2d');
                this.charts.marketTrend = new Chart(marketTrendCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['상승', '하락', '보합'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#28a745', '#dc3545', '#6c757d'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            async startCollection() {
                try {
                    const response = await fetch(`${this.apiBase}/start`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert('데이터 수집이 시작되었습니다.', 'success');
                        this.isRunning = true;
                        this.updateStatus();
                    } else {
                        this.showAlert(data.message || '시작 실패', 'danger');
                    }
                } catch (error) {
                    this.showAlert('서버 연결 오류', 'danger');
                }
            }
            
            async stopCollection() {
                try {
                    const response = await fetch(`${this.apiBase}/stop`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert('데이터 수집이 중지되었습니다.', 'warning');
                        this.isRunning = false;
                        this.updateStatus();
                    } else {
                        this.showAlert(data.message || '중지 실패', 'danger');
                    }
                } catch (error) {
                    this.showAlert('서버 연결 오류', 'danger');
                }
            }
            
            async refreshData() {
                await this.updateAllData();
            }
            
            async updateAllData() {
                await Promise.all([
                    this.updateStatus(),
                    this.updateStockData(),
                    this.updateMarketTrend(),
                    this.updateHotStocks()
                ]);
            }
            
            async updateStatus() {
                try {
                    const response = await fetch(`${this.apiBase}/status`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 서버 상태 업데이트
                        const statusElement = document.getElementById('server-status');
                        if (data.server_running) {
                            statusElement.className = 'badge bg-success fs-6';
                            statusElement.innerHTML = '<i class="fas fa-circle"></i> 수집 중';
                        } else {
                            statusElement.className = 'badge bg-warning fs-6';
                            statusElement.innerHTML = '<i class="fas fa-circle"></i> 대기 중';
                        }
                        
                        // 통계 업데이트
                        if (data.collector_stats) {
                            document.getElementById('total-stocks').textContent = data.collector_stats.subscribed_count || 0;
                            document.getElementById('data-received').textContent = data.collector_stats.data_received || 0;
                            document.getElementById('data-processed').textContent = data.collector_stats.data_processed || 0;
                            document.getElementById('error-count').textContent = data.collector_stats.errors || 0;
                            
                            if (data.collector_stats.last_update) {
                                const lastUpdate = new Date(data.collector_stats.last_update);
                                document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
                            }
                        }
                    }
                } catch (error) {
                    console.error('상태 업데이트 오류:', error);
                }
            }
            
            async updateStockData() {
                try {
                    const response = await fetch(`${this.apiBase}/data`);
                    const data = await response.json();
                    
                    if (response.ok && data.data) {
                        this.renderStockTable(data.data);
                    }
                } catch (error) {
                    console.error('종목 데이터 업데이트 오류:', error);
                }
            }
            
            renderStockTable(stocks) {
                const tbody = document.getElementById('stock-data-table');
                
                if (stocks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">데이터가 없습니다.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stocks.map(stock => `
                    <tr>
                        <td><strong>${stock.code}</strong></td>
                        <td>${stock.name}</td>
                        <td class="${stock.change_rate >= 0 ? 'price-up' : 'price-down'}">
                            ${stock.current_price.toLocaleString()}원
                        </td>
                        <td class="${stock.change_rate >= 0 ? 'price-up' : 'price-down'}">
                            ${stock.change_rate >= 0 ? '+' : ''}${stock.change_rate.toFixed(2)}%
                        </td>
                        <td>${stock.volume.toLocaleString()}</td>
                        <td>${(stock.amount / 1000000).toFixed(0)}백만</td>
                        <td>${stock.high_price.toLocaleString()}</td>
                        <td>${stock.low_price.toLocaleString()}</td>
                        <td>${new Date(stock.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `).join('');
            }
            
            async updateMarketTrend() {
                try {
                    const response = await fetch(`${this.apiBase}/analysis/market-trend`);
                    const data = await response.json();
                    
                    if (response.ok && data.analysis) {
                        const analysis = data.analysis;
                        
                        // 차트 업데이트
                        this.charts.marketTrend.data.datasets[0].data = [
                            analysis.up_count || 0,
                            analysis.down_count || 0,
                            analysis.flat_count || 0
                        ];
                        this.charts.marketTrend.update();
                        
                        // 평균 등락률 표시
                        if (analysis.avg_change_rate !== undefined) {
                            const avgElement = document.createElement('div');
                            avgElement.className = 'text-center mt-2';
                            avgElement.innerHTML = `
                                <small class="text-muted">
                                    평균 등락률: 
                                    <span class="${analysis.avg_change_rate >= 0 ? 'price-up' : 'price-down'}">
                                        ${analysis.avg_change_rate >= 0 ? '+' : ''}${analysis.avg_change_rate.toFixed(2)}%
                                    </span>
                                </small>
                            `;
                            
                            const chartContainer = document.getElementById('marketTrendChart').parentElement;
                            const existingAvg = chartContainer.querySelector('.text-center');
                            if (existingAvg) {
                                existingAvg.remove();
                            }
                            chartContainer.appendChild(avgElement);
                        }
                    }
                } catch (error) {
                    console.error('시장 추세 업데이트 오류:', error);
                }
            }
            
            async updateHotStocks() {
                try {
                    const response = await fetch(`${this.apiBase}/analysis/hot-stocks?min_change_rate=3.0`);
                    const data = await response.json();
                    
                    if (response.ok && data.hot_stocks) {
                        this.renderHotStocks(data.hot_stocks);
                    }
                } catch (error) {
                    console.error('급등/급락 종목 업데이트 오류:', error);
                }
            }
            
            renderHotStocks(hotStocks) {
                const container = document.getElementById('hot-stocks-list');
                
                if (hotStocks.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">급등/급락 종목이 없습니다.</p>';
                    return;
                }
                
                container.innerHTML = hotStocks.slice(0, 5).map(stock => `
                    <div class="stock-item ${stock.type === 'down' ? 'down' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${stock.code}</strong> ${stock.name}
                            </div>
                            <div class="${stock.change_rate >= 0 ? 'price-up' : 'price-down'}">
                                ${stock.change_rate >= 0 ? '+' : ''}${stock.change_rate.toFixed(2)}%
                            </div>
                        </div>
                        <div class="text-muted small">
                            ${stock.current_price.toLocaleString()}원 | 거래량: ${stock.volume.toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
            
            async exportData() {
                try {
                    const response = await fetch(`${this.apiBase}/export?format=csv`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(`데이터가 ${data.filename}로 내보내기되었습니다.`, 'success');
                    } else {
                        this.showAlert('데이터 내보내기 실패', 'danger');
                    }
                } catch (error) {
                    this.showAlert('데이터 내보내기 오류', 'danger');
                }
            }
            
            async subscribeStocks() {
                const codesInput = document.getElementById('stock-codes');
                const codes = codesInput.value.split(',').map(code => code.trim()).filter(code => code);
                
                if (codes.length === 0) {
                    this.showAlert('종목 코드를 입력해주세요.', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiBase}/subscribe`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ codes })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showAlert(data.message, 'success');
                        codesInput.value = '';
                        bootstrap.Modal.getInstance(document.getElementById('subscribeModal')).hide();
                        this.updateStatus();
                    } else {
                        this.showAlert(data.message || '구독 실패', 'danger');
                    }
                } catch (error) {
                    this.showAlert('서버 연결 오류', 'danger');
                }
            }
            
            startAutoUpdate() {
                setInterval(() => {
                    if (this.isRunning) {
                        this.updateAllData();
                    }
                }, this.updateInterval);
            }
            
            showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alertId = 'alert-' + Date.now();
                
                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                alertContainer.insertAdjacentHTML('beforeend', alertHtml);
                
                // 5초 후 자동 제거
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        alert.remove();
                    }
                }, 5000);
            }
        }
        
        // 대시보드 초기화
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new RealTimeDashboard();
            window.dashboard.updateAllData();
        });
    </script>
</body>
</html> 