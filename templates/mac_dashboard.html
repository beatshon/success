<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>맥 전용 투자 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            🍎 맥 전용 투자 대시보드
                            <span class="status-indicator status-running" id="serverStatus"></span>
                            <small class="float-end" id="lastUpdate"></small>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- 포트폴리오 요약 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>📊 포트폴리오 요약</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6>총 자산</h6>
                                <h4 id="totalValue">₩0</h4>
                            </div>
                            <div class="col-6">
                                <h6>수익률</h6>
                                <h4 id="profitRate" class="profit-positive">0%</h4>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>총 수익</h6>
                            <h4 id="totalProfit" class="profit-positive">₩0</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 실시간 주가 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>📈 실시간 주가</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>종목코드</th>
                                        <th>현재가</th>
                                        <th>변동</th>
                                        <th>거래량</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- 투자 신호 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>🎯 투자 신호</h5>
                    </div>
                    <div class="card-body">
                        <div id="signalsList">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 뉴스 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>📰 최신 뉴스</h5>
                    </div>
                    <div class="card-body">
                        <div id="newsList">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 제어 패널 -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>⚙️ 제어 패널</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success me-2" onclick="startVirtualData()">가상 데이터 시작</button>
                        <button class="btn btn-danger me-2" onclick="stopVirtualData()">가상 데이터 중지</button>
                        <button class="btn btn-primary" onclick="refreshData()">데이터 새로고침</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            updateInterval = setInterval(refreshData, 5000); // 5초마다 업데이트
        });
        
        async function refreshData() {
            try {
                // 서버 상태 확인
                const statusResponse = await fetch('/api/status');
                const status = await statusResponse.json();
                
                // 주식 데이터
                const stockResponse = await fetch('/api/stock-data');
                const stockData = await stockResponse.json();
                
                // 포트폴리오 데이터
                const portfolioResponse = await fetch('/api/portfolio');
                const portfolio = await portfolioResponse.json();
                
                // 투자 신호
                const signalsResponse = await fetch('/api/signals');
                const signals = await signalsResponse.json();
                
                // 뉴스 데이터
                const newsResponse = await fetch('/api/news');
                const news = await newsResponse.json();
                
                // UI 업데이트
                updateUI(status, stockData, portfolio, signals, news);
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }
        
        function updateUI(status, stockData, portfolio, signals, news) {
            // 서버 상태
            document.getElementById('serverStatus').className = 
                `status-indicator ${status.virtual_data_running ? 'status-running' : 'status-stopped'}`;
            
            // 마지막 업데이트 시간
            document.getElementById('lastUpdate').textContent = 
                new Date().toLocaleTimeString();
            
            // 포트폴리오 업데이트
            document.getElementById('totalValue').textContent = 
                `₩${portfolio.total_value.toLocaleString()}`;
            document.getElementById('totalProfit').textContent = 
                `₩${portfolio.total_profit.toLocaleString()}`;
            document.getElementById('profitRate').textContent = 
                `${(portfolio.profit_rate * 100).toFixed(2)}%`;
            
            // 수익률 색상
            const profitRateElement = document.getElementById('profitRate');
            const totalProfitElement = document.getElementById('totalProfit');
            if (portfolio.profit_rate >= 0) {
                profitRateElement.className = 'profit-positive';
                totalProfitElement.className = 'profit-positive';
            } else {
                profitRateElement.className = 'profit-negative';
                totalProfitElement.className = 'profit-negative';
            }
            
            // 주식 테이블 업데이트
            updateStockTable(stockData);
            
            // 투자 신호 업데이트
            updateSignalsList(signals);
            
            // 뉴스 업데이트
            updateNewsList(news);
        }
        
        function updateStockTable(stockData) {
            const tbody = document.getElementById('stockTable');
            tbody.innerHTML = '';
            
            Object.entries(stockData).forEach(([code, data]) => {
                const row = document.createElement('tr');
                const changeClass = data.change >= 0 ? 'profit-positive' : 'profit-negative';
                const changeSymbol = data.change >= 0 ? '+' : '';
                
                row.innerHTML = `
                    <td><strong>${code}</strong></td>
                    <td>₩${data.current_price.toLocaleString()}</td>
                    <td class="${changeClass}">${changeSymbol}${data.change.toLocaleString()}</td>
                    <td>${data.volume.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateSignalsList(signals) {
            const container = document.getElementById('signalsList');
            container.innerHTML = '';
            
            signals.forEach(signal => {
                const signalElement = document.createElement('div');
                signalElement.className = 'alert alert-info mb-2';
                signalElement.innerHTML = `
                    <strong>${signal.name} (${signal.code})</strong><br>
                    신호: <span class="badge bg-primary">${signal.signal}</span>
                    신뢰도: ${(signal.confidence * 100).toFixed(1)}%
                    목표가: ₩${signal.target_price.toLocaleString()}
                `;
                container.appendChild(signalElement);
            });
        }
        
        function updateNewsList(news) {
            const container = document.getElementById('newsList');
            container.innerHTML = '';
            
            news.forEach(item => {
                const newsElement = document.createElement('div');
                newsElement.className = 'alert alert-secondary mb-2';
                const sentimentClass = item.sentiment === 'positive' ? 'text-success' : 'text-danger';
                newsElement.innerHTML = `
                    <div class="${sentimentClass}"><strong>${item.title}</strong></div>
                    <small class="text-muted">${new Date(item.timestamp).toLocaleString()}</small>
                `;
                container.appendChild(newsElement);
            });
        }
        
        async function startVirtualData() {
            try {
                await fetch('/api/start-virtual-data', { method: 'POST' });
                alert('가상 데이터 생성이 시작되었습니다.');
            } catch (error) {
                alert('가상 데이터 시작 실패: ' + error.message);
            }
        }
        
        async function stopVirtualData() {
            try {
                await fetch('/api/stop-virtual-data', { method: 'POST' });
                alert('가상 데이터 생성이 중지되었습니다.');
            } catch (error) {
                alert('가상 데이터 중지 실패: ' + error.message);
            }
        }
    </script>
</body>
</html>